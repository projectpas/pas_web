<p-breadcrumb [model]="breadcrumbs" [home]="home"></p-breadcrumb>
<div class="card new-card">
    <div class="card-header header">
        <div class="row">
            <div class="col">
                <h4 class="header-name">Sales Order List</h4>
            </div>
            <div>
                <button type="button" class="btn-sm header-button" matTooltipPosition="above"
                    matTooltip="Create Sales Order" [routerLink]="['/salesmodule/salespages/sales-order']">
                    Create Sales Order
                </button>
            </div>
        </div>
    </div>
    <div class="card-body new-card-body">
        <p-table #dt [value]="sales" class="rpo-table-cstm rro-table-cstm" [first]="0" [rows]="pageSize"
            [paginator]="showPaginator" [pageLinks]="3" [rowsPerPageOptions]="[10, 20, 50, 100]"
            [columns]="selectedColumns" selectionMode="multiple" [metaKeySelection]="true"
            [(selection)]="selectedColumn" [lazy]="true" (onLazyLoad)="loadData($event)" [resizableColumns]="true"
            [reorderableColumns]="true" [totalRecords]="totalRecords" [scrollable]="true" [style]="{ width: '100%' }">

            <ng-template pTemplate="caption">
                <div class="row">
                    <div class="col">
                        <p-multiSelect [options]="headers" [(ngModel)]="selectedColumns" optionLabel="header"
                            selectedItemsLabel="{0} columns selected" [style]="{minWidth: '200px'}"
                            defaultLabel="Choose Columns" style="float:left">
                        </p-multiSelect>
                    </div>
                    <div class="col">
                        <div style="width: auto !important; float: right;"
                            class="inner-addon right-addon w50 inline-block g-filter-search-cstm">
                            <i class="fa fa-search"></i>
                            <input type="text" pInputText size="50" class="form-control"
                                (input)="globalSearch($event.target.value)" placeholder="Filter">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <button type="button" class="btn btn-primary new-table-button" matTooltip="Download Data"
                            matTooltipPosition="above" pButton icon="fa-download" iconPos="left" label="Export Data"
                            data-toggle="modal" (click)="selectedOnly = false; targetData = dt;"
                            data-target="#downloadConfirmation"></button>
                        <button type="button" class="btn btn-primary new-table-button"
                            matTooltip="Download Selected Data" matTooltipPosition="above" pButton icon="fa-download"
                            iconPos="left" label="Export Selected Data"
                            (click)="dt.exportCSV({selectionOnly:true})"></button>
                        <!-- data-toggle="modal"
                            data-target="#downloadConfirmation"
                            (click)="selectedOnly = true; targetData = dt;" -->
                        <div class="pull-left" style="margin-top: 4px; margin-right: 15px;">
                            <label class="radio-cstm wauto">
                                <input type="radio" name="viewType" class="form-control" value="pnview"
                                    [(ngModel)]="viewType" (click)="changeOfStatus('','pnview')">
                                <span class="checkmark"></span>PN View
                            </label>
                        </div>
                        <div class="pull-left" style="margin-top: 4px; margin-right: 15px;">
                            <label class="radio-cstm wauto">
                                <input type="radio" name="viewType" class="form-control" value="soview"
                                    [(ngModel)]="viewType" (click)="changeOfStatus('','soview')">
                                <span class="checkmark"></span>SO View
                            </label>
                        </div>

                    </div>
                    <div class="pull-right" style="padding-left:0px;">
                        <div class="">
                            <div class="col" style="float: right; padding: 3px 0 0;">
                                <div class="form-group">
                                    <div class="pull-left" style="margin-top: 4px; margin-right: 15px;"
                                        *ngFor="let status of statusList">
                                        <label class="radio-cstm wauto">
                                            <input type="radio" name="currentStatus" class="form-control"
                                                value="{{status.value}}" [(ngModel)]="currentStatus"
                                                (change)="clearText(currentStatus); changeOfStatus(status.value, '')">
                                            <span class="checkmark"></span>{{status.label}}
                                        </label>
                                    </div>
                                    <div class="pull-left" style="margin-top: 4px; margin-right: 15px;">
                                        <label class="radio-cstm wauto">
                                            <input type="radio" name="currentStatusSo" class="form-control" value="0"
                                                [(ngModel)]="currentStatus" checked="{{currentStatus == 0}}"
                                                (change)="clearText(currentStatus); changeOfStatus(0, '')">
                                            <span class="checkmark"></span>All
                                        </label>
                                    </div>
                                    <div class="checkbox-cstm pull-right" style="margin-left: 0;">
                                        <label style="width: auto !important;margin-top: 3px;">
                                            <!--  -->
                                            <input type="checkbox" [(ngModel)]="currentDeletedstatus" name="cparent"
                                                id="cparent" (click)="getDeleteListByStatus($event.target.checked)" />
                                            <span class="cr"><i class="cr-icon pi pi-check"></i></span>
                                            Show Deleted List
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>
            <ng-template pTemplate="colgroup" let-columns>
                <colgroup>
                    <col *ngFor="let col of columns" [ngStyle]="{'width': col.width}" />
                </colgroup>
            </ng-template>
            <ng-template pTemplate="header" let-columns>
                <tr>
                    <th *ngFor="let col of columns" pResizableColumn pReorderableColumn [pSortableColumn]="col.field">
                        {{ col.header }}
                        <p-sortIcon [field]="col.field"></p-sortIcon>
                    </th>
                    <th style="width:100px;position:sticky !important">
                        Actions
                    </th>
                </tr>
                <tr>
                    <th [ngStyle]="{'width': col.width}" *ngFor="let col of columns" [ngSwitch]="col.field">
                        <ng-container *ngIf="col.field == 'status'">
                            <input *ngIf="col.field !== 'quoteDate' 
                            && col.field !== 'openDate'
                            && col.field !== 'requestedDateType' 
                            && col.field !== 'estimatedShipDateType' 
                            && col.field !== 'createdDate'
                            && col.field !== 'updatedDate'" #filterStatusInput
                                [disabled]="col.field == 'status' &&  currentStatus !='0'" style="width:100%;"
                                pInputText type="text" (input)="dt.filter($event.target.value, col.field, 'contains')">
                        </ng-container>
                        <ng-container *ngIf="col.field != 'status'">
                            <input *ngIf="col.field !== 'quoteDate'
                            && col.field !== 'openDate'
                            && col.field !== 'requestedDateType' 
                            && col.field !== 'estimatedShipDateType'  
                            && col.field !== 'createdDate'
                            && col.field !== 'updatedDate'" [disabled]="col.field == 'status' &&  currentStatus !='0'"
                                style="width:100%;" pInputText type="text"
                                (input)="dt.filter($event.target.value, col.field, 'contains')">
                        </ng-container>
                        <input type="date" *ngIf="col.field == 'quoteDate'" name="quoteDate" style="width:100%;"
                            (change)="dt.filter($event.target.value, col.field, 'contains')">
                        <input type="date" *ngIf="col.field == 'createdDate'" name="createdDate" style="width:100%;"
                            (change)="dt.filter($event.target.value, col.field, 'contains')">
                        <input type="date" *ngIf="col.field == 'updatedDate'" name="updatedDate" style="width:100%;"
                            (change)="dt.filter($event.target.value, col.field, 'contains')">
                        <input type="date" *ngIf="col.field == 'openDate'" name="openDate" style="width:100%;"
                            (change)="dt.filter($event.target.value, col.field, 'contains')">
                        <input type="date" *ngIf="col.field == 'requestedDateType'" name="requestedDateType"
                            style="width:100%;" (change)="dt.filter($event.target.value, col.field, 'contains')">
                        <input type="date" *ngIf="col.field == 'estimatedShipDateType'" name="estimatedShipDateType"
                            style="width:100%;" (change)="dt.filter($event.target.value, col.field, 'contains')">

                        <!-- <input style="width:100%;" pInputText type="text"
                                (input)="dt.filter($event.target.value, col.field, 'contains')"> -->
                    </th>
                    <th style="width:100px;position:sticky !important"></th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex" let-expanded="expanded"
                let-columns="columns">
                <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex" pReorderableRowHandle
                    [pSelectableRowDblClick]="rowData">
                    <td *ngFor="let col of columns" style="text-overflow: ellipsis;"
                        [matTooltip]="mouseOverData(col.field,  rowData)" matTooltipPosition="above"
                        [matTooltipDisabled]="rowData['partDescriptionType'] != 'Multiple' ||
                                rowData['partNumberType'] != 'Multiple'  || 
                                rowData['requestedDateType'] != 'Multiple'||
                                    rowData['estimatedShipDateType'] != 'Multiple'||
                                    rowData['priorityType'] != 'Multiple'"
                        [ngStyle]="{'color': getColorCodeForMultiple(rowData)}">
                        <!-- {{convertDate(col.field , rowData)}} -->
                        <span
                            *ngIf="col.field != 'createdDate' && col.field != 'updatedDate' && col.field != 'openDate'">
                            {{convertDate(col.field , rowData)}}
                        </span>
                        <span *ngIf="col.field == 'openDate'">
                            {{convertDate(col.field , rowData) | date: 'MM/dd/yyyy'}}
                        </span>
                        <span *ngIf="col.field == 'createdDate' || col.field == 'updatedDate'">
                            {{convertDate(col.field , rowData) | date: 'MM/dd/yyyy h:mm a '}}
                        </span>
                    </td>
                    <td style="width: 100px">

                        <div *ngIf="currentDeletedstatus==false">
                            <span>
                                <a class="btn nobg" (click)="viewSelectedRow(viewOrder,rowData)" matTooltip="View"
                                    matTooltipPosition="above"><i class="fa fa-eye"></i></a>
                            </span>
                            <span>
                                <a class="btn nobg" (click)="openOrderToEdit(rowData)" matTooltip="Edit"
                                    matTooltipPosition="above">
                                    <i class="fa fa-pencil"></i>
                                </a>
                            </span>
                            <span>
                                <a class="btn nobg" (click)="openDelete(content,rowData)" matTooltip="Delete"
                                    matTooltipPosition="above">
                                    <i class="fa fa-trash"></i>
                                </a>
                            </span>
                            <!-- <span data-toggle="modal" data-target="#soHistory">
                                <a class="btn nobg btn-hist-cstm" (click)="getAuditHistoryById(rowData)"
                                    matTooltip="History" matTooltipPosition="above"><i class="fa fa-history"></i></a>
                            </span> -->
                            <span>
                                <a class="btn nobg btn-hist-cstm" (click)="getAuditHistoryById(soHistory,rowData)"
                                    matTooltip="History" matTooltipPosition="above"><i class="fa fa-history"></i></a>
                            </span>
                        </div>

                        <div *ngIf="currentDeletedstatus==true">
                            <span>
                                <a class="btn nobg" (click)="viewSelectedRow(viewOrder,rowData)" matTooltip="View"
                                    matTooltipPosition="above"><i class="fa fa-eye"></i></a>
                            </span>
                            <span>
                                <a class="btn nobg btn-hist-cstm" (click)="getAuditHistoryById(soHistory,rowData)"
                                    matTooltip="History" matTooltipPosition="above"><i class="fa fa-history"></i></a>
                            </span>
                            <span><a class="btn nobg" (click)="restore(restoreIdSo,rowData);"
                                    matTooltip="Restore Record" matTooltipPosition="above"><i class="fa fa-undo"
                                        aria-hidden="true"></i></a> </span>

                        </div>
                        <!-- <button class="btn-delete" mat-icon-button matTooltip="Delete"
                                matTooltipPosition="above" (click)="openDelete(content,sale)">
                                <mat-icon color="warn">delete</mat-icon>
                            </button> -->

                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" let-columns *ngIf="sales.length == 0">
                <tr>
                    <td [attr.colspan]="19" style="color: red; font-weight: bold; text-align: center">
                        No records found
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="summary" id="footer">
                <label id="footer" class="footer">Total:</label>
                <input style="width: 5%;" [(ngModel)]="dt._totalRecords" [disabled]="true" pInputText type="text" />
                &nbsp;&nbsp;
                <label id="footer" class="footer1">Pages Count:</label>

                <input style="width: 5%;" [ngModel]="totalPages" [disabled]="true" pInputText type="text" />
            </ng-template>
        </p-table>
    </div>
</div>
<div class="modal fade" id="downloadConfirmation" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" (click)="closeDeleteModal()">&times;</button>
                <h4 class="modal-title">Are You Sure Want to Download?</h4>
            </div>
            <div class="modal-body" *ngIf="targetData && !selectedOnly">
                <strong>
                    <span>
                        You are attempting to export {{targetData.totalRecords}} of records.
                    </span>
                </strong>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary"
                    (click)="(selectedOnly)?targetData.exportCSV({ selectionOnly: true }):exportCSV(targetData); closeDeleteModal();">Confirm</button>
                <button type="button" class="btn btn-danger" (click)="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<ng-template #content let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Are You Sure Want to Delete?</h4>
        <button type="button" class="close" aria-label="Close" (click)="dismissModel()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <h6 class="modal-body">SO Number : {{selectedSalesOrderToDelete}}</h6>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-success" (click)="deleteQuote()">Yes</button>
        <button type="button" class="btn btn-danger" (click)="dismissModel()">No</button>
    </div>

</ng-template>
<ng-template #restoreIdSo let-c="close" let-d="dismiss" data-backdrop="static">

    <div class="modal-header">
        <h4 class="modal-title">Are You Sure Want to Restore?</h4>

        <button type="button" class="close" aria-label="Close" (click)="dismissModel()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <h6 class="modal-body">SO Number : {{restorerecord.salesOrderNumber}}</h6>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-success" (click)="restoreRecord()">Yes</button>
        <button type="button" class="btn btn-danger" (click)="dismissModel()">No</button>
    </div>
</ng-template>
<ng-template #viewOrder let-c="close" let-d="dismiss">
    <div class="modal-header">
        <button type="button" class="close" (click)="dismissModel()">
            &times;
        </button>
        <h4 class="modal-title">Details of Sales Order</h4>
    </div>

    <div class="modal-body">
        <app-sales-order-view [customerId]="customerId" [salesOrderId]="salesOrderId" [salesOrderView]="salesOrderView">
        </app-sales-order-view>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="dismissModel()">Close</button>
    </div>

</ng-template>

<!-- <div class="preloader loader-position" *ngIf="isSpinnerVisible">
    <div class="loader-css loader-align">
        <img src="../../../../assets/images/loader.gif" />
    </div>
</div> -->
<div class="preloader" *ngIf="isSpinnerVisible">
    <div class="loading">
        <div class="lds-roller">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
</div>
<!-- <div id="soHistory" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false"> -->
<ng-template #soHistory let-c="close" let-d="dismiss" data-backdrop="static">
    <!-- <div class="modal-dialog modal-xl"> -->
    <!-- Modal content-->
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" aria-label="Close" (click)="dismissModel()">
                <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">History of Sales Order</h4>
        </div>
        <div class="modal-body" *ngIf="auditHistory">
            <div class="table-responsive">
                <table class="table table-bordered" *ngIf="auditHistory.length> 0 else noDatavailable">
                    <thead>
                        <tr>
                            <th>SO Num</th>
                            <th>Quote Num</th>
                            <th>Status</th>
                            <th>Customer Name</th>
                            <th>Customer Type</th>
                            <th>Cust Ref</th>
                            <th>Priority</th>
                            <th>Sales person</th>
                            <th>Created Date</th>
                            <th>Created By</th>
                            <th>Updated Date</th>
                            <th>Updated By</th>
                            <th>Is Deleted</th>
                        </tr>
                    </thead>
                    <tbody class="audithistory-cstm">
                        <tr *ngFor="let audit of auditHistory; let i = index;">
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'salesOrderNumber', audit.salesOrderNumber)  ? 'black' : 'red'  }">
                                {{audit.salesOrderNumber}}</td>
                            <td
                                [ngStyle]="{'color':  getColorCodeForHistory(i, 'salesOrderQuoteNumber', audit.salesOrderQuoteNumber)  ? 'black' : 'red'  }">
                                {{audit.salesOrderQuoteNumber}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'status', audit.status)  ? 'black' : 'red'  }">
                                {{audit.status}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'customerName', audit.customerName)  ? 'black' : 'red'  }">
                                {{audit.customerName}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'customerType', audit.customerType)  ? 'black' : 'red'  }">
                                {{audit.customerType}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'customerReference', audit.customerReference)  ? 'black' : 'red'  }">
                                {{audit.customerReference}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'priority', audit.priorityType)  ? 'black' : 'red'  }">
                                {{audit.priority}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'salesPerson', audit.salesPerson)  ? 'black' : 'red'  }">
                                {{audit.salesPerson}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'createdDate', audit.createdDate)  ? 'black' : 'red'  }">
                                {{audit.createdDate | date: 'MM/dd/yyyy h:mm a '}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'createdBy', audit.createdBy)  ? 'black' : 'red'  }">
                                {{audit.createdBy}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'updatedDate', audit.updatedDate)  ? 'black' : 'red'  }">
                                {{audit.updatedDate | date: 'MM/dd/yyyy h:mm a '}}</td>
                            <td
                                [ngStyle]="{'color': getColorCodeForHistory(i, 'updatedBy', audit.updatedBy)  ? 'black' : 'red'  }">
                                {{audit.updatedBy}}</td>
                            <td>
                                <p style="background-color: #fff !important;"> <input type="checkbox" name="isDeleted"
                                        [(ngModel)]="audit.isDeleted" disabled></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <ng-template #noDatavailable>
                    <div class="text-center">
                        <img src="../../../../assets/images/binoculars.png" style="height: 100px; width: 100px;">
                        <h4 style="color: #ff5663;">No History Found </h4>
                    </div>
                </ng-template>
            </div>
        </div>
        <div class="preloader" style="z-index: 10000;" *ngIf="isSpinnerVisible">
            <div class="loading">
                <div class="lds-roller">
                    <div>
                    </div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>
        <app-spinner *ngIf="isSpinnerVisible"></app-spinner>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" (click)="dismissModel()">Close</button>
        </div>
    </div>
    <!-- </div> -->
</ng-template>