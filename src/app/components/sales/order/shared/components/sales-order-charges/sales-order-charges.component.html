<div class="form-group">
  <div class="row" *ngIf="!isView" style="padding:8px">
    <button data-target="#addNewCharges" data-toggle="modal" (click)="createNew()" class="btn btn-primary"
      style="margin-left: 10px;">
      Add Charges
    </button>
  </div>
  <div class="row">
    <p-table [columns]="cols" [value]="salesOrderChargesList" [lazy]="false" [paginator]="true" [rows]="10"
      class="rpo-table-cstm ptable-f10" [paginator]="true">
      <!--chargess-->
      <ng-template pTemplate="header" let-columns>
        <tr>
          <th colspan="7" style="background: #fff; border: 1px solid #fff;border-right: 1px solid #e7ecf1;">
            &nbsp;
          </th>
          <ng-container *ngIf="isView">
            <th colspan="4" style="background: #fff; border: 1px solid #e7ecf1;padding-left: 5px;">
              <div class="display-flex">
                <div class="form-group" style="text-align: center; display: flex;    margin-bottom: 0px;">
                  <p-radioButton class="p-radiobutton-label-horizontal p-radiobutton-label-w92" name="costPlusType"
                    label="T&M - Mark Up" value="1" [(ngModel)]="costPlusType" [disabled]="isView" (click)="tmchange()">
                  </p-radioButton>
                  <div>
                    <select class="form-group select-markup" (change)="markupChanged({}, 'all')"
                      [(ngModel)]="overAllMarkup" [disabled]="isView || costPlusType != '1'" style="margin-top: 10px;">
                      <option value="" selected>Select</option>
                      <option *ngFor="let markUp of markupList" [value]="markUp.value">{{markUp.label}}</option>
                    </select>
                  </div>
                </div>
                <div style="float: left; margin-bottom: 7px; margin-left: 4px; margin-right: 4px;">
                  <p-radioButton class="p-radiobutton-label-horizontal" name="costPlusType" value="2" label="Actual"
                    [(ngModel)]="costPlusType" [disabled]="isView" (click)="(!isView)?tmchange():''"></p-radioButton>
                </div>
                <div>
                  <p-radioButton class="p-radiobutton-label-horizontal" name="costPlusType" value="3" label="Flat Rate"
                    [(ngModel)]="costPlusType" [disabled]="isView" (click)="(!isView)?tmchange():''">
                  </p-radioButton>
                </div>
              </div>
            </th>
          </ng-container>
          <ng-container *ngIf="!isView">
            <th colspan="4" style="background: #fff; border: 1px solid #e7ecf1;padding: 0;">
              <div class="display-flex">
                <div class="form-group" style="text-align: center; display: flex;    margin-bottom: 0px;">
                  <p-radioButton class="p-radiobutton-label-horizontal p-radiobutton-label-w92" name="costPlusType"
                    label="T&M - Mark Up" value="1" [(ngModel)]="costPlusType" [disabled]="isView" (click)="tmchange()">
                  </p-radioButton>
                  <div>
                    <select class="form-group select-markup" (change)="markupChanged({}, 'all')"
                      [(ngModel)]="overAllMarkup" [disabled]="isView || costPlusType != '1'" style="margin-top: 10px;">
                      <option value="" selected>Select</option>
                      <option *ngFor="let markUp of markupList" [value]="markUp.value">{{markUp.label}}</option>
                    </select>
                  </div>
                </div>
                <div style="float: left; margin-bottom: 7px; margin-left: 4px; margin-right: 4px;">
                  <p-radioButton class="p-radiobutton-label-horizontal" name="costPlusType" value="2" label="Actual"
                    [(ngModel)]="costPlusType" [disabled]="isView" (click)="tmchange()"></p-radioButton>
                </div>
                <div>
                  <p-radioButton class="p-radiobutton-label-horizontal" name="costPlusType" value="3" label="Flat Rate"
                    [(ngModel)]="costPlusType" [disabled]="isView" (click)="(!isView)?tmchange():''">
                  </p-radioButton>
                </div>
              </div>
            </th>
          </ng-container>
        </tr>
        <tr>
          <th rowspan="2">Type<span class="clr-red">*</span></th>
          <th rowspan="2">Description</th>
          <th rowspan="2">Qty<span class="clr-red">*</span></th>
          <th rowspan="2">Ref Num</th>
          <th rowspan="2">Unit Cost<span class="clr-red">*</span></th>
          <th rowspan="2">Extended Cost<span class="clr-red">*</span></th>
          <th rowspan="2">Vendor Name</th>
          <ng-container>
            <th rowspan="2">Billing Method</th>
            <th rowspan="2">Mark Up</th>
            <th rowspan="2">Billing Rate</th>
            <th rowspan="2">Billing Amount</th>
          </ng-container>
          <th rowspan="2" *ngIf="!isView">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-charge let-columns="columns" let-rowIndex="rowIndex">
        <tr *ngIf="!charge['isDeleted']">
          <td>
            <select class="form-control custom-select wf-pub-id" id="dllChargesType" [(ngModel)]="charge.chargesTypeId"
              style="width: 130px;" name="type_{{i}}" [disabled]="true">
              <option [value]="0">Select</option>
              <option [value]="ctype.chargeId" *ngFor="let ctype of chargesTypes">{{
                ctype.chargeType
              }}</option>
            </select>
          </td>
          <td>
            {{charge.description}}
          </td>
          <td style="text-align: right;">
            {{charge.quantity | globalNmberFormat}}
          </td>
          <td>
            {{charge.refNum}}
          </td>
          <td style="text-align: right;">
            {{charge.unitCost | twoDecimalGlobalNumberFormatPipe}}
          </td>
          <td style="text-align: right;">
            {{charge.extendedCost | twoDecimalGlobalNumberFormatPipe}}
          </td>
          <!-- <td>
            {{getVendorNameById(charge.vendorId)}}
          </td> -->
          <td>
            {{charge.vendor ? charge.vendor.vendorName : ''}}
          </td>
          <ng-container>
            <td>
              <select class="form-control" [(ngModel)]="charge.billingMethodId" [disabled]="isView || costPlusType == 3"
                (change)="charge.markupPercentageId = '';charge.billingRate = 0;charge.billingAmount = 0;(charge.billingMethodId == '2')?charge.billingAmount = charge.extendedCost:'';">
                <option value="" selected>Select</option>
                <option *ngFor="let bm of [{'label': 'T&M', 'value': '1'}, {'label': 'Actual', 'value': '2'}]"
                  [value]="bm.value">{{bm.label}}</option>
              </select>
            </td>
            <td>
              <select class="form-control select-markup" (change)="markupChanged(charge, 'row')"
                [(ngModel)]="charge.markupPercentageId" [disabled]="isView || charge.billingMethodId != '1'">
                <option value="" selected>Select</option>
                <option *ngFor="let markUp of markupList" [value]="markUp.value">{{ markUp.label }}</option>
              </select>
            </td>
            <td>
              <input type="text" pInputText pKeyFilter="money" class="form-control text_right"
                value="{{ formateCurrency(charge.billingRate) }}"
                (change)="charge.billingRate = formateCurrency(charge.billingRate)" [(ngModel)]="charge.billingRate"
                [disabled]="true" />
            </td>
            <td>
              <input type="text" pInputText pKeyFilter="money" class="form-control text_right"
                value="{{ formateCurrency(charge.billingAmount) }}"
                (change)="charge.billingAmount = formateCurrency(charge.billingAmount)"
                [(ngModel)]="charge.billingAmount" [disabled]="isView || charge.billingMethodId != '2'" />
            </td>
          </ng-container>
          <td class="btn-spaces text-center" *ngIf="!isView">
            <span data-target="#addNewCharges" data-toggle="modal">
              <a class="btn nobg btn-edit-cstm" (click)="edit(charge, rowIndex)" matTooltip="Edit">
                <i class="fa fa-pencil"></i>
              </a>
            </span>
            <span>
              <a class="btn nobg btn-delete-cstm" (click)="delete(charge, rowIndex)" matTooltip="Delete">
                <i class="fa fa-trash"></i>
              </a>
            </span>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="footer">
        <tr class="footer">
          <td>Total</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td class="content-to-end">{{formateCurrency(calculateExtendedCostSummation())}}</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <ng-container *ngIf="costPlusType != 3">
            <td class="content-to-end">{{formateCurrency(getTotalBillingAmount())}}</td>
          </ng-container>
          <ng-container *ngIf="costPlusType == 3">
            <td>
              <input type="text" pInputText pKeyFilter="money" style="text-align: right;"
                [ngModel]="chargesFlatBillingAmount  | twoDecimalGlobalNumberFormatPipe"
                [ngModelOptions]="{updateOn:'blur'}"
                (ngModelChange)="chargesFlatBillingAmount=formatStringToNumberGlobal($event)"
                (blur)="chargesFlatBillingAmount = (chargesFlatBillingAmount)?formateCurrency(chargesFlatBillingAmount):'0.00'"
                [disabled]="isView" />
            </td>
            <!-- <td>
              <input type="text" pInputText pKeyFilter="money" style="text-align: right;"
                (blur)="chargesFlatBillingAmount = (chargesFlatBillingAmount)?formateCurrency(chargesFlatBillingAmount):'0.00'"
                [(ngModel)]="chargesFlatBillingAmount" [disabled]="isView" />
            </td> -->
          </ng-container>
          <td *ngIf="!isView">&nbsp;</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  <div *ngIf="!isView" style="padding: 10px;">
    <button class="btn btn-primary pull-right side" (click)="createChargesQuote()">
      Save
    </button>
  </div>

</div>



<div id="addNewCharges" class="modal fade" role="dialog" *ngIf="!view" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-xl">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          &times;
        </button>
        <h4 class="modal-title"> {{isEdit ? 'Edit' : 'Add'}} Charges</h4>
      </div>
      <div class="modal-body">
        <div *ngIf="!isEdit">
          <span class="cat-heading cat4 ng-star-inserted">
            Add Charges
            <i class="fa fa-plus" (click)="addNewRow()"></i>
          </span>
        </div>
        <div class="tab-content">
          <div class="table-responsive table-overflow" style="height: 300px;">
            <form #chargesCreateForm="ngForm">
              <table class="table table-bordered ">
                <thead>
                  <tr>
                    <th rowspan="2">Type<span class="clr-red">*</span></th>
                    <th rowspan="2">Description</th>
                    <th rowspan="2">Qty<span class="clr-red">*</span></th>
                    <th rowspan="2">Ref Num</th>
                    <th rowspan="2">Unit Cost<span class="clr-red">*</span></th>
                    <th rowspan="2">Extended Cost<span class="clr-red">*</span></th>
                    <th rowspan="2">Vendor Name</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let charge of chargeForm; let i = index">
                    <!-- (change)="onChargeTypeChange($event, charge)" -->
                    <td>
                      <select class="form-control custom-select wf-pub-id" id="dllChargesType"
                        [(ngModel)]="charge.chargesTypeId" style="width: 130px;" name="type_{{i}}" required>
                        <option [value]="">Select</option>
                        <option [value]="ctype.chargeId" *ngFor="let ctype of chargesTypes">{{
                          ctype.chargeType
                        }}</option>
                      </select>
                    </td>
                    <td>
                      <input type="text" pInputText value="{{ charge.description }}" [(ngModel)]="charge.description"
                        class="form-control" name="desc_{{i}}" />
                    </td>
                    <td>
                      <input type="text" pInputText pKeyFilter="pnum" maxlength="15" class="form-control text-right"
                        value="{{ charge.quantity }}" (change)="calculateExtendedCost(charge)"
                        [(ngModel)]="charge.quantity" name="qty_{{i}}" required />
                    </td>
                    <td>
                      <input type="text" pInputText maxlength="15" class="form-control" value="{{ charge.refNum }}"
                        [(ngModel)]="charge.refNum" name="refNum_{{i}}" />
                    </td>
                    <td>
                      <input type="text" pInputText pKeyFilter="money" class="form-control text-right"
                        value="{{ charge.unitCost }}" (change)="calculateExtendedCost(charge)"
                        [(ngModel)]="charge.unitCost" name="unitCost_{{i}}" required maxlength="15" />
                    </td>
                    <td>
                      <input type="text" pInputText pKeyFilter="money" class="form-control text-right" [disabled]="true"
                        value="{{ charge.extendedCost }}" [(ngModel)]="charge.extendedCost"
                        (change)="calculateExtendedCostSummation()" name="exd_{{i}}" required disabled maxlength="15" />
                    </td>
                    <td>
                      <p-autoComplete class="autocomp-customer-cstm" name="vendorName" [(ngModel)]="charge.vendor"
                        [ngModelOptions]="{standalone: true}" [suggestions]="vendorCollection" [forceSelection]="true"
                        emptyMessage="No Match Found" field="vendorName" (completeMethod)="filterVendor($event)"
                        [size]="30" [minLength]="1" [dropdown]="true">
                      </p-autoComplete>
                      <!-- <p-autoComplete [(ngModel)]="charge.vendorId" [suggestions]="vendorCollection"
                        [forceSelection]="true" (completeMethod)="filterVendor($event)" [dropdown]="true" [size]="30"
                        [minLength]="1" field="vendorName" class="workflow-measurement-select" name="vendo_{{i}}">
                      </p-autoComplete> -->
                    </td>
                  </tr>
                </tbody>
              </table>
            </form>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <!-- [disabled]="!chargesCreateForm.valid" -->
        <button class="btn btn-primary pull-right " (click)="saveFreightList()" [disabled]="!chargesCreateForm.valid">
          {{ isEdit ? 'Update' : (isQuote)?'Save':'Save' }}
        </button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
<div class="preloader" *ngIf="isSpinnerVisible">
  <div class="loading">
    <div class="lds-roller">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
  </div>
</div>